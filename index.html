<!doctype html>
<html>
<head>
  <meta charset="utf-8"/>
  <title>Street Light Monitor (Live)</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.3/dist/leaflet.css"/>
  <style>
    html,body,#map{height:100%;margin:0;padding:0}
    #map{height:92vh}
    h2{text-align:center;margin:8px 0}
  </style>
</head>
<body>
  <h2>Street Light Monitor (Live)</h2>
  <div id="map"></div>

  <script src="https://unpkg.com/leaflet@1.9.3/dist/leaflet.js"></script>
  <script>
    const channelID = "3126641";   // âœ… Your channel ID

    const map = L.map('map').setView([19.4675, 72.873], 13);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

    let markers = [];

    async function refresh() {
      markers.forEach(m => map.removeLayer(m));
      markers = [];

      const url = `https://api.thingspeak.com/channels/${channelID}/feeds.json?results=50`;
      const res = await fetch(url);
      const data = await res.json();
      const feeds = data.feeds || [];

      const unique = {};

      feeds.reverse().forEach(f => {
        const lat = parseFloat(f.field4);
        const lon = parseFloat(f.field5);
        const fault = Number(f.field6);

        if (!lat || !lon) return;

        const key = `${lat}|${lon}`;
        if (!unique[key]) unique[key] = { lat, lon, fault };
      });

      Object.values(unique).forEach(loc => {
        const color = loc.fault === 1 ? 'red' : 'green';

        const marker = L.circleMarker([loc.lat, loc.lon], {
          radius: 10,
          color: color,
          fillColor: color,
          fillOpacity: 1
        }).addTo(map);

        marker.bindPopup(
          `<b>Lat:</b> ${loc.lat}<br><b>Lon:</b> ${loc.lon}<br><b>Fault:</b> ${loc.fault}`
        );

        markers.push(marker);
      });
    }

    refresh();
    setInterval(refresh, 10000);
  </script>
</body>
</html>


